<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>room-detail</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #96c2ee;
            color: #fff;
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .top-bar a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px;
        }

        .top-bar a:hover {
            text-decoration: none;
        }

        .top2-bar {
            background-color: #3ecbd8;
            color: #0f0e0e;
            padding: 10px 20px;
            position: sticky;
            text-align: center;
            top: 0;
            z-index: 999;
        }

        .top2-bar a {
            color: #fff;
            text-decoration: none;
            margin: 0 5px;
        }

        .room-select {
            display: flex;
            align-items: center;
            margin-left: 54%;
        }

        .top2-bar .top-foot {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #fff;
        }

        .top2-bar .top-foot p {
            color: #171616;
        }

        .top3-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e7db32;
            color: #ff0000;
            padding: 10px 20px;
            text-align: left;
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .content {
            padding: 20px;
            background-color: #fff;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .room-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-info img {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 8px;
        }

        .room-details {
            margin-top: 20px;
        }

        .room-details p {
            margin: 5px 0;
            color: #34495e;
        }

        .room-details .date-selection {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .room-details .date-selection label {
            font-weight: bold;
            color: #333;
        }

        .room-details .date-selection input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            height: 36px;
            width: 150px;
            /* ç»™æ—¥æœŸè¾“å…¥æ¡†åˆé€‚çš„å®½åº¦ */
        }

        .room-details .date-selection span {
            color: #666;
            font-weight: bold;
        }

        .book-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        .book-button:hover {
            background-color: #40a9ff;
        }

        .customer-service {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body>

    <body>
        <div class="head">
            <div id="top" class="top-bar">
                <div id="link">
                    <a href="">admin@xiaoliucc.con</a>
                    <a href="">21-2327-2888</a>
                    <a href="">æ¹–åŒ—ç¬¬äºŒå¸ˆèŒƒå­¦é™¢ é‚®ç¼–ï¼š430200</a>
                </div>
                <div class="admin-action">
                    <a href="admin.html">è¿›å…¥åå°</a>
                    <a href="#" onclick="logout()">é€€å‡º</a>
                </div>
            </div>
            <div id="top-2" class="top2-bar">
                <div id="room-select" class="room-select">
                    <a href="">é¦–é¡µ</a>
                    <a href="">å¤§åºŠæˆ¿</a>
                    <a href="">åŒåºŠæˆ¿</a>
                    <a href="">å¤šåºŠæˆ¿</a>
                    <a href="">å½±éŸ³æˆ¿</a>
                    <a href="">æƒ…ä¾£æˆ¿</a>
                    <a href="">å®¶åº­æˆ¿</a>
                    <a href="">æ•´æ ‹åˆ«å¢…</a>
                </div>
                <h1>å¸Œæœ›ç»™æ‚¨ç•™ä¸‹ä¸€æ®µç¾å¥½çš„å›å¿†</h1>
                <div class="top-foot">
                    <a href="home.html" class="mid-home">é¦–é¡µ</a>
                    <p>| å®¢æˆ¿åˆ—è¡¨</p>
                </div>
            </div>
            <div id="top-3" class="top3-bar">
                <p>
                    1,æœ¬ç«™ä¸ºå­¦ä¹ é¡¹ç›®ï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»åˆ é™¤ï¼
                    2,æœ¬ç³»ç»Ÿç”±Java+SpringBoot+MySQL+HTML5+cssç­‰æŠ€æœ¯å¼€å‘å®Œæˆ
                    3ï¼Œç®¡ç†å‘˜ç™»å½•è´¦å·ï¼šxiaoliucc å¯†ç ï¼š123456
                </p>
            </div>
        </div>
        <div class="content">
            <div class="room-info">
                <img id="roomImage" src="" alt="æˆ¿é—´å›¾ç‰‡">
                <div class="room-details">
                    <h2 id="roomType">æˆ¿é—´ç±»å‹</h2>
                    <p id="roomNumber">æˆ¿é—´å·</p>
                    <p id="roomPrice">ä»·æ ¼ï¼šï¿¥XXX/æ™š</p>
                    <p id="roomDescription">æˆ¿é—´ä»‹ç»</p>
                    <p id="bookedTimes">å·²è¢«é¢„è®¢æ—¶é—´ï¼šXXX - XXX</p>
                    <div class="date-selection">
                        <label for="checkIn">é¢„è®¢æ—¥æœŸ</label>
                        <input type="date" id="checkIn">
                        <span>--</span>
                        <input type="date" id="checkOut" title="è¯·é€‰æ‹©é€€æˆ¿æ—¥æœŸ" placeholder="è¯·é€‰æ‹©é€€æˆ¿æ—¥æœŸ">
                    </div>
                    <button class="book-button" onclick="bookRoom()">é¢„è®¢</button>
                </div>
            </div>
            <div class="customer-service">
                <p>å®¢æœç”µè¯ï¼š21-2327-2888</p>
            </div>
        </div>
        <script>
            // const baseUrl = 'http://localhost:8080';
            const baseUrl = window.location.hostname.includes('localhost')
                ? 'http://localhost:8080'
                : '';  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨åŒ¹é…å½“å‰åŸŸå
            let bookedTimeRanges = []; // å­˜å‚¨å·²é¢„è®¢çš„æ—¶é—´æ®µ
            function logout() {
                // æ¸…é™¤ç™»å½•çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨çš„tokenï¼‰
                localStorage.removeItem('token');
                // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            }

            document.addEventListener('DOMContentLoaded', function () {
                const roomId = new URLSearchParams(window.location.search).get('id');
                if (!roomId) {
                    alert('æ— æ•ˆçš„æˆ¿é—´ID');
                    window.location.href = 'home.html';
                    return;
                }

                Promise.all([
                    fetch(`${baseUrl}/api/room/detail/${roomId}`, {
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                    }),
                    fetch(`${baseUrl}/api/room-images/room/${roomId}`, {
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                    }),
                    fetch(`${baseUrl}/api/order/room/${roomId}/booked-times`, {
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                    })
                ])
                    .then(response => Promise.all(response.map(response => response.json())))
                    .then(([roomResult, imageResult, orderResult]) => {
                        console.log('æˆ¿é—´æ•°æ®', roomResult);
                        console.log('å›¾ç‰‡æ•°æ®', imageResult);

                        if (roomResult.code === 200) {
                            const room = roomResult.data;
                            // åŠ è½½åŸºç¡€æ•°æ®
                            document.getElementById('roomType').textContent = room.type || 'æœªçŸ¥ç±»å‹';
                            document.getElementById('roomNumber').textContent = `æˆ¿é—´å·: ${room.roomNumber || 'æœªçŸ¥'}`;
                            document.getElementById('roomPrice').textContent = `ä»·æ ¼: ï¿¥${room.price || 'æœªçŸ¥'}/æ™š`;
                            document.getElementById('roomDescription').innerHTML = 'å…¨æ–°å‡çº§çš„è±ªåå¥—æˆ¿é¢ç§¯è¿‘ç™¾å¹³æ–¹ç±³ï¼Œæ»¡è¶³æ‚¨æ›´é«˜å“è´¨å±…ä½éœ€æ±‚...';

                            if (imageResult.code === 200 && imageResult.data.length > 0) {
                                const primaryImage = imageResult.data.find(img => img.isPrimary) || imageResult.data[0];
                                console.log('primaryImage', primaryImage)
                                let imageUrl = primaryImage.imageUrl;

                                // åˆ¤æ–­æ˜¯å¦å·²ç»æ˜¯å®Œæ•´URL
                                if (!imageUrl.startsWith('http')) {
                                    imageUrl = `${baseUrl}${imageUrl}`;
                                }
                                document.getElementById('roomImage').src = imageUrl;
                                document.getElementById('roomImage').alt = room.type;
                            } else {
                                // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡æˆ–å ä½ç¬¦
                                document.getElementById('roomImage').src = `${baseUrl}/images/default-room.jpg`;
                                document.getElementById('roomImage').alt = 'é»˜è®¤æˆ¿é—´å›¾ç‰‡';
                            }
                        } else {
                            throw new Error(roomResult.msg || 'è·å–æˆ¿é—´è¯¦æƒ…å¤±è´¥');
                        }
                        if (orderResult.code === 200) {
                            const bookedOrders = orderResult.data;
                            bookedTimeRanges = bookedOrders || [];
                            displayBookedTimes(bookedOrders);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching room details:', error);
                        alert('è·å–æˆ¿é—´è¯¦æƒ…å¤±è´¥: ' + error.message);
                    });

                fetch(`${baseUrl}/api/room/detail/${roomId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                    .then(response => {
                        console.log('Fetch response status:', response.status);
                        return response;
                    })
                    .then(response => response.json())
                    .then(result => {
                        console.log('å®Œæ•´APIå“åº”:', result);
                        if (result.code === 200) {
                            const room = result.data;
                            console.log('æˆ¿é—´æ•°æ®:', room); // è°ƒè¯•è¾“å‡º

                            // åŠ è½½åŸºç¡€æ•°æ®
                            document.getElementById('roomType').textContent = room.type || 'æœªçŸ¥ç±»å‹';
                            document.getElementById('roomNumber').textContent = `æˆ¿é—´å·: ${room.roomNumber || 'æœªçŸ¥'}`;
                            document.getElementById('roomPrice').textContent = `ä»·æ ¼: ï¿¥${room.price || 'æœªçŸ¥'}/æ™š`;
                            document.getElementById('roomDescription').innerHTML = 'å…¨æ–°å‡çº§çš„è±ªåå¥—æˆ¿é¢ç§¯è¿‘ç™¾å¹³æ–¹ç±³ï¼Œæ»¡è¶³æ‚¨æ›´é«˜å“è´¨å±…ä½éœ€æ±‚ã€‚æˆ¿é—´åŒ…å«ä¸€å®¤ä¸€å…ä¸¤å«åŠå¤šä¸ªæ›´è¡£é—´ï¼Œç§»é—¨åˆ†éš”çš„å®¢å…å’Œå§å®¤å¯å¹³è¡¡ç¤¾äº¤ä¸ç§å¯†éœ€æ±‚ã€‚å®½æ•çš„å®¢å…æ‹¥æœ‰èˆ’é€‚çš„æ²™å‘åŒºï¼Œç‹¬ç«‹çš„é¤æ¡Œã€å†°ç®±ã€å¾®æ³¢ç‚‰ã€Nespressoå’–å•¡æœºã€å†™å­—å°ã€å‚¨ç‰©æŸœï¼Œ65å¯¸é«˜æ¸…å¯æ—‹è½¬LCDç”µè§†ï¼Œè´´å¿ƒæ»¡è¶³é•¿æœŸå±…ä½æˆ–å°å‹ç¤¾äº¤æ´»åŠ¨éœ€æ±‚ã€‚å§å®¤é…å¤‡è¶…å¤§èˆ’é€‚åºŠå“ã€æ— çº¿åŠUSBå……ç”µè£…ç½®ï¼Œå¸¦æš—æ ¼æ”¶çº³çš„æ¢³å¦†é•œå°ã€‚æ‚¨ä¹Ÿå¯å°Šäº«è¡Œæ”¿æ¥¼å±‚ç¤¼é‡ï¼Œåœ¨å……æ»¡æ‘©ç™»è€ä¸Šæµ·é£æƒ…çš„è¡Œæ”¿é…’å»Šå°½äº«æ—©é¤ã€ä¸‹åˆèŒ¶ã€æ¬¢ä¹æ—¶å…‰åŠä¼šè®®å®¤ã€‚';

                            //åŠ è½½é¢„è®¢æ—¶é—´
                            return fetch(`${baseUrl}/api/order/room/${roomId}/booked-times`, {
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                                }
                            });

                        } else {
                            throw new Error(result.msg || 'è·å–æˆ¿é—´è¯¦æƒ…å¤±è´¥');
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.code === 200) {
                            const bookedOrders = result.data;
                            bookedTimeRanges = bookedOrders || [];
                            displayBookedTimes(bookedOrders);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching room details:', error);
                        alert('è·å–æˆ¿é—´è¯¦æƒ…å¤±è´¥: ' + error.message);
                    });

                // è®¾ç½®æ—¥æœŸé€‰æ‹©çš„æœ€å°å€¼ä¸ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkIn').setAttribute('min', today);
                document.getElementById('checkOut').setAttribute('min', today);

                // ç›‘å¬æ—¥æœŸå˜åŒ–
                document.getElementById('checkIn').addEventListener('change', validateDates);
                document.getElementById('checkOut').addEventListener('change', validateDates);
            });
            //æ˜¾ç¤ºé¢„è®¢æ—¶é—´
            function displayBookedTimes(bookedOrders) {
                const bookedTimesElem = document.getElementById('bookedTimes');
                if (!bookedOrders || bookedOrders.length === 0) {
                    bookedTimesElem.innerHTML = '<span style="color: green;">âœ… å½“å‰å¯é¢„è®¢</span>';
                    return;
                }
                // æ ¼å¼åŒ–é¢„è®¢æ—¶é—´
                const timeRanges = bookedOrders.map(order => {
                    try {
                        const checkIn = new Date(order.checkIn).toISOString().split('T')[0];
                        const checkOut = new Date(order.checkOut).toISOString().split('T')[0];
                        return `${checkIn} è‡³ ${checkOut}`;
                    } catch (e) {
                        console.error('æ—¥æœŸæ ¼å¼é”™è¯¯:', e);
                        return 'æœªçŸ¥æ—¶é—´';
                    }
                });

                bookedTimesElem.innerHTML = `<strong>ğŸ“… å·²é¢„è®¢æ—¶æ®µ:</strong><br>${timeRanges.join('<br>')}`;
            }
            //éªŒè¯æ—¥æœŸ
            function validateDates() {
                const checkIn = document.getElementById('checkIn').value;
                const checkOut = document.getElementById('checkOut').value;
                const bookButton = document.querySelector('.book-button');

                bookButton.disabled = true;
                bookButton.textContent = 'é¢„è®¢';

                if (!checkIn || !checkOut) {
                    return;
                }

                const validation = validateDateRules(checkIn, checkOut);
                if (!validation.valid) {
                    alert(validation.message);
                    return;
                }

                const conflictCheck = checkDateConflicts(checkIn, checkOut);
                if (!conflictCheck.isAvailable) {
                    alert(conflictCheck.message);
                    return;
                }

                bookButton.disabled = false;
                bookButton.textContent = 'é¢„è®¢';
            }
            function validateDateRules(checkIn, checkOut) {
                const today = new Date();
                const checkInDate = new Date(checkIn);
                const checkOutDate = new Date(checkOut);
                today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºä»Šå¤©çš„å¼€å§‹æ—¶é—´
                if (checkInDate < today) {
                    return { valid: false, message: 'å…¥ä½æ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©' };
                }
                if (checkOutDate <= checkInDate) {
                    return { valid: false, message: 'ç¦»åº—æ—¥æœŸå¿…é¡»æ™šäºå…¥ä½æ—¥æœŸ' };
                }
                const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
                if (nights > 30) {
                    return { valid: false, message: 'æœ€é•¿é¢„è®¢30æ™š' };
                }
                return { valid: true };
            }
            function checkDateConflicts(checkIn, checkOut) {
                const checkInDate = new Date(checkIn);
                const checkOutDate = new Date(checkOut);

                for (const order of bookedTimeRanges) {
                    const orderStart = new Date(order.checkIn);
                    const orderEnd = new Date(order.checkOut);
                    if (
                        (checkInDate >= orderStart && checkInDate < orderEnd) ||
                        (checkOutDate > orderStart && checkOutDate <= orderEnd) ||
                        (checkInDate <= orderStart && checkOutDate >= orderEnd)
                    ) {
                        return { isAvailable: false, message: `æ‰€é€‰æ—¥æœŸä¸å·²æœ‰é¢„è®¢å†²çª(${order.checkIn}è‡³${order.checkOut})` };
                    };
                }
                return { isAvailable: true };
            }


            //é¢„è®¢æˆ¿é—´
            function bookRoom() {
                const roomId = new URLSearchParams(window.location.search).get('id');
                const checkIn = document.getElementById('checkIn').value;
                const checkOut = document.getElementById('checkOut').value;
                if (!roomId) {
                    alert('æ— æ•ˆçš„æˆ¿é—´ID');
                    return;
                }
                if (!checkIn || !checkOut) {
                    alert('è¯·é€‰æ‹©å…¥ä½å’Œç¦»åº—æ—¥æœŸ');
                    return;
                }
                //éªŒè¯æ—¥æœŸ
                const validation = validateDateRules(checkIn, checkOut);
                if (!validation.valid) {
                    alert(validation.message);
                    return;
                }
                const conflictCheck = checkDateConflicts(checkIn, checkOut);
                if (!conflictCheck.isAvailable) {
                    alert(conflictCheck.message);
                    return;
                }
                const bookButton = document.querySelector('.book-button');
                bookButton.disabled = true;
                bookButton.textContent = 'é¢„è®¢ä¸­...';

                fetch(`${baseUrl}/api/order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        roomId: parseInt(roomId),
                        checkIn: checkIn,
                        checkOut: checkOut
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.code === 200) {
                            alert('é¢„è®¢æˆåŠŸï¼');
                            window.location.reload();
                        } else {
                            alert('é¢„è®¢å¤±è´¥ï¼š' + result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error booking room:', error);
                        alert('é¢„è®¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                    });

            }

        </script>
    </body>

</html>